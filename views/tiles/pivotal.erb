<% @owners_id = [] %>
<% @stories_for_owners = [] %>


<% @objects.each do |items| %>
    <% unless @owners_id.include?(items["owned_by_id"]) %>
      <% @owners_id.push(items["owned_by_id"]) %>
    <% end %>
<% end %>


<% @counter = [] %>
<% @owners_id.each do |owner_id| %>
  <% @objects.each do |items| %>
    <% if items["owned_by_id"] == owner_id %>
      <% @counter << 1 %>
    <% end %>
  <% end %>
  <% @stories_for_owners.push({"owner_id"=> owner_id, "story_amount"=> @counter.count}) %>
  <% @counter.clear %>
<% end %>

<div id="chart"></div>


 <script type="text/javascript">

  var rubyJson = <%= @stories_for_owners.to_json %>;

  var w = 500,
      h = 150;

  var svg = d3.select("#chart")
    .append("svg")
    .attr("width", w)
    .attr("height", h);

  var color = d3.scale.category20();

  var data = rubyJson;

  var max_n = 0;
  for (var d in data) {
    max_n = Math.max(data[d].story_amount, max_n);
  }

  var dx = w / max_n;
  var dy = h / data.length;

  // bars
  var bars = svg.selectAll(".bar")
    .data(data)
    .enter()
    .append("rect")
    .attr("class", function(d, i) {return "bar " + d.owner_id;})
    .attr("x", function(d, i) {return 0;})
    .attr("y", function(d, i) {return dy*i;})
    .attr("fill", function(d, i) { return color(i); })
    .attr("width", function(d, i) {return dx*d.story_amount})
    .attr("height", dy);

  // labels
  var text = svg.selectAll("text")
    .data(data)
    .enter()
    .append("text")
    .attr("class", function(d, i) {return "owner_id " + d.owner_id;})
    .attr("x", 5)
    .attr("y", function(d, i) {return dy*i + 15;})
    .text( function(d) {return d.owner_id + " (" + d.story_amount  + ")";})
    .attr("font-size", "15px")
    .style("font-weight", "bold");
  </script> 

